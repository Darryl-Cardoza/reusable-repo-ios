name: "iOS CI - Reusable (Xcode)"

on:
  workflow_call:
    inputs:
      xcode_version:
        required: false
        type: string
        default: "latest-stable"

      scheme:
        required: true
        type: string

      # Use ONE of these:
      workspace:
        required: false
        type: string
        default: ""
      project:
        required: false
        type: string
        default: ""

      configuration:
        required: false
        type: string
        default: "Release"

      coverage_threshold:
        required: false
        type: string
        default: "0" # "0" disables coverage gate

      build_archive:
        required: false
        type: boolean
        default: true

    outputs:
      coverage_percent:
        description: "Computed iOS line coverage percent"
        value: ${{ jobs.ci.outputs.coverage_percent }}

defaults:
  run:
    shell: bash

concurrency:
  group: ios-ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: Reusable iOS CI Pipeline
    runs-on: macos-latest
    outputs:
      coverage_percent: ${{ steps.coverage.outputs.coverage_percent }}

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        if: ${{ inputs.xcode_version != 'latest-stable' }}
        run: |
          set -euo pipefail
          sudo xcode-select -s "/Applications/Xcode_${{ inputs.xcode_version }}.app/Contents/Developer"
          xcodebuild -version

      - name: Resolve SPM (optional but helps caching)
        run: |
          set -euo pipefail
          xcodebuild -resolvePackageDependencies \
            ${{ inputs.workspace != '' && format('-workspace "{0}"', inputs.workspace) || '' }} \
            ${{ inputs.project != '' && format('-project "{0}"', inputs.project) || '' }} \
            -scheme "${{ inputs.scheme }}" | xcpretty || true

      # -----------------------
      # TEST + COVERAGE
      # -----------------------
      - name: Pick iOS simulator and run tests
        env:
          SCHEME: ${{ inputs.scheme }}
          WORKSPACE: ${{ inputs.workspace }}
          PROJECT: ${{ inputs.project }}
        run: |
          set -euo pipefail

          echo "ðŸ”Ž Available runtimes:"
          xcrun simctl list runtimes

          echo "ðŸ”Ž Available devices:"
          xcrun simctl list devices available

          # Get iOS runtime versions (newest first). Example values: 26.2, 26.1, 18.6, 18.5
          mapfile -t IOS_VERSIONS < <(
            xcrun simctl list runtimes \
              | awk '/^iOS/ && !/unavailable/ {print $2}' \
              | sort -V -r
          )

          if [ "${#IOS_VERSIONS[@]}" -eq 0 ]; then
            echo "âŒ No iOS runtimes found."
            exit 1
          fi

          echo "âœ… Candidate iOS runtimes: ${IOS_VERSIONS[*]}"

          pick_device_for_version() {
            local ver="$1"
            xcrun simctl list devices available \
              | awk -v ver="$ver" '
                  $0 ~ "-- iOS "ver" --" {inblock=1; next}
                  /^--/ {inblock=0}
                  inblock && $0 ~ /iPhone/ {
                    line=$0
                    sub(/^.*\(/, "", line)
                    sub(/\).*/, "", line)
                    print line
                    exit
                  }
                '
          }

          DEVICE_UDID=""
          IOS_VERSION_USED=""

          for ver in "${IOS_VERSIONS[@]}"; do
            udid="$(pick_device_for_version "$ver" || true)"
            if [ -n "${udid:-}" ]; then
              DEVICE_UDID="$udid"
              IOS_VERSION_USED="$ver"
              break
            fi
          done

          if [ -z "${DEVICE_UDID:-}" ]; then
            echo "âŒ No available iPhone simulator found for any iOS runtime."
            exit 1
          fi

          echo "âœ… Picked iOS runtime: $IOS_VERSION_USED"
          echo "âœ… Picked iPhone UDID: $DEVICE_UDID"

          # Boot simulator (safe if already booted)
          xcrun simctl boot "$DEVICE_UDID" || true
          xcrun simctl bootstatus "$DEVICE_UDID" -b

          # Save result bundle path so later steps can read it
          RESULT_BUNDLE="$RUNNER_TEMP/${SCHEME}.xcresult"
          echo "RESULT_BUNDLE=$RESULT_BUNDLE" >> "$GITHUB_ENV"

          # Build xcodebuild args for workspace/project
          XCB_ARGS=()
          if [ -n "${WORKSPACE:-}" ]; then
            XCB_ARGS+=(-workspace "$WORKSPACE")
          fi
          if [ -n "${PROJECT:-}" ]; then
            XCB_ARGS+=(-project "$PROJECT")
          fi

          # Run tests + coverage + xcresult output
          xcodebuild test \
            "${XCB_ARGS[@]}" \
            -scheme "$SCHEME" \
            -destination "id=$DEVICE_UDID" \
            -enableCodeCoverage YES \
            -resultBundlePath "$RESULT_BUNDLE" \
            | xcpretty

      - name: Compute Coverage (Line %) + Gate
        id: coverage
        run: |
          set -euo pipefail

          TH="${{ inputs.coverage_threshold }}"
          RESULT="${RESULT_BUNDLE:-}"

          if [ -z "$RESULT" ] || [ ! -d "$RESULT" ]; then
            echo "âŒ xcresult not found at RESULT_BUNDLE=$RESULT"
            exit 1
          fi

          LINE=$(xcrun xccov view --report "$RESULT" | grep -E "Line Coverage" | head -n 1 || true)
          if [ -z "$LINE" ]; then
            echo "âŒ Could not parse line coverage from xccov."
            xcrun xccov view --report "$RESULT" | head -n 60 || true
            exit 1
          fi

          PCT=$(echo "$LINE" | sed -E 's/.*Line Coverage: ([0-9]+\.[0-9]+)%.*/\1/')
          echo "coverage_percent=$PCT" >> "$GITHUB_OUTPUT"
          echo "ðŸ“Š Line Coverage: ${PCT}%"

          # Threshold=0 means no gate
          if awk -v th="$TH" 'BEGIN{exit !(th+0>0)}'; then
            PASS=$(awk -v p="$PCT" -v th="$TH" 'BEGIN { print (p+0 >= th+0) ? "1" : "0" }')
            if [ "$PASS" -ne 1 ]; then
              echo "âŒ Coverage ${PCT}% is below threshold ${TH}%"
              exit 1
            fi
            echo "âœ… Coverage gate passed (${PCT}% >= ${TH}%)"
          else
            echo "â„¹ï¸ Coverage gate disabled (threshold=${TH})"
          fi

      # -----------------------
      # ARCHIVE (unsigned)
      # -----------------------
      - name: Build Unsigned Archive (.xcarchive)
        if: ${{ inputs.build_archive }}
        run: |
          set -euo pipefail

          ARCHIVE_PATH="$RUNNER_TEMP/ios-archive-unsigned.xcarchive"
          echo "ARCHIVE_PATH=$ARCHIVE_PATH" >> "$GITHUB_ENV"

          xcodebuild archive \
            ${{ inputs.workspace != '' && format('-workspace "{0}"', inputs.workspace) || '' }} \
            ${{ inputs.project != '' && format('-project "{0}"', inputs.project) || '' }} \
            -scheme "${{ inputs.scheme }}" \
            -configuration "${{ inputs.configuration }}" \
            -destination "generic/platform=iOS" \
            -archivePath "$ARCHIVE_PATH" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            | xcpretty

      # -----------------------
      # ARTIFACTS
      # -----------------------
      - name: Upload Test Results (.xcresult)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-test-results
          path: ${{ env.RESULT_BUNDLE }}

      - name: Upload Unsigned iOS Archive
        if: ${{ inputs.build_archive }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-archive-unsigned
          path: ${{ env.ARCHIVE_PATH }}
