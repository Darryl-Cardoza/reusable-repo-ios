name: "iOS CI - Reusable (Xcode)"

on:
  workflow_call:
    inputs:
      xcode_version:
        required: false
        type: string
        default: "latest-stable"

      scheme:
        required: true
        type: string

      workspace:
        required: false
        type: string
        default: ""
      project:
        required: false
        type: string
        default: ""

      configuration:
        required: false
        type: string
        default: "Release"

      coverage_threshold:
        required: false
        type: string
        default: "0"

      build_archive:
        required: false
        type: boolean
        default: true

    outputs:
      coverage_percent:
        value: ${{ jobs.ci.outputs.coverage_percent }}

defaults:
  run:
    shell: bash

jobs:
  ci:
    runs-on: macos-latest
    outputs:
      coverage_percent: ${{ steps.coverage.outputs.coverage_percent }}

    steps:
      - uses: actions/checkout@v4

      # Optional Xcode version
      - name: Select Xcode
        if: ${{ inputs.xcode_version != 'latest-stable' }}
        run: |
          sudo xcode-select -s "/Applications/Xcode_${{ inputs.xcode_version }}.app/Contents/Developer"
          xcodebuild -version

      # Resolve packages
      - name: Resolve Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            ${{ inputs.workspace != '' && format('-workspace "{0}"', inputs.workspace) || '' }} \
            ${{ inputs.project != '' && format('-project "{0}"', inputs.project) || '' }} \
            -scheme "${{ inputs.scheme }}" || true

      # -----------------------
      # TEST (macOS destination â€” no simulator instability)
      # -----------------------
      - name: Run Unit Tests (No Signing)
        run: |
          set -euo pipefail

          RESULT_BUNDLE="$RUNNER_TEMP/TestResults.xcresult"
          echo "RESULT_BUNDLE=$RESULT_BUNDLE" >> $GITHUB_ENV

          xcodebuild test \
          ${{ inputs.workspace != '' && format('-workspace "{0}"', inputs.workspace) || '' }} \
          ${{ inputs.project != '' && format('-project "{0}"', inputs.project) || '' }} \
          -scheme "${{ inputs.scheme }}" \
          -destination 'platform=iOS Simulator,name=iPhone 16' \
          -resultBundlePath "$RESULT_BUNDLE" \
          -enableCodeCoverage YES \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGN_IDENTITY="" \
          DEVELOPMENT_TEAM="" \
          PROVISIONING_PROFILE_SPECIFIER="" \
          | xcpretty
          

  # -----------------------
      # COVERAGE
      # -----------------------
      - name: Compute Coverage + Gate
        id: coverage
        run: |
          set -euo pipefail

          TH="${{ inputs.coverage_threshold }}"
          RESULT="${RESULT_BUNDLE:-}"

          if [ -z "$RESULT" ] || [ ! -d "$RESULT" ]; then
            echo "âŒ xcresult not found"
            exit 1
          fi

          echo "ðŸ”Ž Coverage targets:"
          xcrun xccov view --report "$RESULT"

          APP_NAME="${{ inputs.scheme }}.app"

          LINE=$(xcrun xccov view --report "$RESULT" | grep "$APP_NAME" | head -n 1 || true)

          if [ -z "$LINE" ]; then
            echo "âŒ Could not find $APP_NAME coverage line"
            exit 1
          fi

          PCT=$(echo "$LINE" | awk '{print $(NF-1)}' | tr -d '%')

          echo "coverage_percent=$PCT" >> "$GITHUB_OUTPUT"
          echo "ðŸ“Š App Coverage: ${PCT}%"

          # If threshold is 0 â†’ skip gate
          if awk -v th="$TH" 'BEGIN{exit !(th+0>0)}'; then
            PASS=$(awk -v p="$PCT" -v th="$TH" 'BEGIN { print (p+0 >= th+0) ? "1" : "0" }')
            if [ "$PASS" -ne 1 ]; then
              echo "âŒ Coverage ${PCT}% is below threshold ${TH}%"
              exit 1
            fi
            echo "âœ… Coverage gate passed"
          else
            echo "â„¹ï¸ Coverage gate disabled"
          fi

      # -----------------------
      # ARCHIVE (unsigned)
      # -----------------------
      - name: Build Unsigned Archive
        if: ${{ inputs.build_archive }}
        run: |
          set -euo pipefail

          ARCHIVE_PATH="$RUNNER_TEMP/ios-archive-unsigned.xcarchive"
          echo "ARCHIVE_PATH=$ARCHIVE_PATH" >> $GITHUB_ENV

          xcodebuild archive \
            ${{ inputs.workspace != '' && format('-workspace "{0}"', inputs.workspace) || '' }} \
            ${{ inputs.project != '' && format('-project "{0}"', inputs.project) || '' }} \
            -scheme "${{ inputs.scheme }}" \
            -configuration "${{ inputs.configuration }}" \
            -destination "generic/platform=iOS" \
            -archivePath "$ARCHIVE_PATH" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            | xcpretty

      # -----------------------
      # ARTIFACTS
      # -----------------------
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-test-results
          path: ${{ env.RESULT_BUNDLE }}

      - name: Upload Unsigned Archive
        if: ${{ inputs.build_archive }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-archive-unsigned
          path: ${{ env.ARCHIVE_PATH }}
