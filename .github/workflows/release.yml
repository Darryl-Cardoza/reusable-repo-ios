name: "Reusable iOS CD (Release)"

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string

      deploy_to_testflight:
        required: false
        type: boolean
        default: true

      ios_bundle_id:
        required: true
        type: string

      enable_whats_new:
        required: false
        type: boolean
        default: false

      whats_new_file:
        required: false
        type: string
        default: ""

    secrets:
      # Signing
      IOS_TEAM_ID:
        required: true
      IOS_CERT_P12_BASE64:
        required: true
      IOS_CERT_PASSWORD:
        required: true
      IOS_PROVISION_PROFILE_BASE64:
        required: true

      # App Store Connect API
      APPSTORE_ISSUER_ID:
        required: true
      APPSTORE_KEY_ID:
        required: true
      APPSTORE_PRIVATE_KEY:
        required: true

permissions:
  contents: write

concurrency:
  group: ios-cd-${{ github.ref }}
  cancel-in-progress: false

defaults:
  run:
    shell: bash

jobs:
  create_release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version_check.outputs.version }}
      tag: ${{ steps.version_check.outputs.tag }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next GitHub version
        id: version_check
        run: |
          set -euo pipefail
          BASE_VERSION="${{ inputs.version }}"

          if ! [[ "$BASE_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ inputs.version must be semver like 1.2.3"
            echo "You passed: '$BASE_VERSION'"
            exit 1
          fi

          git fetch --tags
          CURRENT_VERSION="$BASE_VERSION"

          while git rev-parse "v$CURRENT_VERSION" >/dev/null 2>&1; do
            IFS='.' read -r major minor patch <<<"$CURRENT_VERSION"
            patch=$((patch + 1))
            CURRENT_VERSION="$major.$minor.$patch"
          done

          echo "version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version_check.outputs.tag }}
          name: Release ${{ steps.version_check.outputs.tag }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sign_ios:
    name: Sign iOS & Export IPA
    needs: create_release
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download unsigned iOS archive
        uses: actions/download-artifact@v4
        with:
          name: ios-archive-unsigned
          path: release/ios

      - name: Install certificate & profile
        env:
          P12_BASE64: ${{ secrets.IOS_CERT_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
        run: |
          set -euo pipefail

          KEYCHAIN="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PWD="temp"

          security create-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN"

          security list-keychains -d user -s "$KEYCHAIN"
          security default-keychain -d user -s "$KEYCHAIN"

          echo "$P12_BASE64" | base64 --decode > "$RUNNER_TEMP/cert.p12"
          security import "$RUNNER_TEMP/cert.p12" \
            -k "$KEYCHAIN" \
            -P "$P12_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security \
            -T /usr/bin/xcodebuild

          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PWD" "$KEYCHAIN"

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          echo "$PROFILE_BASE64" | base64 --decode > "$RUNNER_TEMP/profile.mobileprovision"

          UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< "$(security cms -D -i "$RUNNER_TEMP/profile.mobileprovision")")
          cp "$RUNNER_TEMP/profile.mobileprovision" "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.mobileprovision"

          echo "✅ Installed provisioning profile UUID: $UUID"
          security find-identity -p codesigning -v

      - name: Generate ExportOptions.plist
        run: |
          set -euo pipefail

          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>

            <key>signingStyle</key>
            <string>manual</string>

            <key>teamID</key>
            <string>${{ secrets.IOS_TEAM_ID }}</string>

            <key>provisioningProfiles</key>
            <dict>
              <key>${{ inputs.ios_bundle_id }}</key>
              <string>DevOpsReleaseProfile</string>
            </dict>

            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF

      - name: Export IPA
        run: |
          set -euo pipefail

          ARCHIVE=$(find release/ios -type d -name "*.xcarchive" | head -n 1)
          if [ -z "$ARCHIVE" ]; then
            echo "❌ No .xcarchive found in release/ios"
            find release/ios -maxdepth 6 -print || true
            exit 1
          fi

          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE" \
            -exportPath "$RUNNER_TEMP/export" \
            -exportOptionsPlist ExportOptions.plist

      - name: Upload signed IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-signed
          path: ${{ runner.temp }}/export/*.ipa

  deploy_testflight:
    name: Deploy to TestFlight
    if: ${{ inputs.deploy_to_testflight }}
    needs: sign_ios
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download signed IPA
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa-signed
          path: release/ios

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: false

      - name: Install fastlane
        run: gem install fastlane -N

      - name: Upload to TestFlight
        env:
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_PRIVATE_KEY: ${{ secrets.APPSTORE_PRIVATE_KEY }}
        run: |
          set -euo pipefail

          IPA=$(find release/ios -name "*.ipa" | head -n 1)
          if [ -z "$IPA" ]; then
            echo "❌ No IPA found in release/ios"
            exit 1
          fi

          echo "$APPSTORE_PRIVATE_KEY" | base64 --decode > AuthKey.p8
          perl -pi -e 's/\r\n/\n/g' AuthKey.p8

          KEY_ESCAPED=$(python3 - <<'PY'
          import json
          p = open("AuthKey.p8", "r", encoding="utf-8").read()
          print(json.dumps(p)[1:-1])
          PY
          )

          cat > api_key.json <<EOF
          {
            "key_id": "${APPSTORE_KEY_ID}",
            "issuer_id": "${APPSTORE_ISSUER_ID}",
            "key": "${KEY_ESCAPED}",
            "in_house": false
          }
          EOF

          CHANGELOG=""
          if [ "${{ inputs.enable_whats_new }}" = "true" ]; then
            if [ -z "${{ inputs.whats_new_file }}" ] || [ ! -f "${{ inputs.whats_new_file }}" ]; then
              echo "❌ whats_new_file missing or not found"
              exit 1
            fi
            CHANGELOG="$(cat "${{ inputs.whats_new_file }}")"
          fi

          if [ -n "$CHANGELOG" ]; then
            fastlane pilot upload --ipa "$IPA" --api_key_path api_key.json --changelog "$CHANGELOG"
          else
            fastlane pilot upload --ipa "$IPA" --api_key_path api_key.json
          fi

  upload_to_release:
    name: Upload IPA to GitHub Release
    needs: [create_release, sign_ios]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download signed IPA
        uses: actions/download-artifact@v4
        with:
          name: ios-ipa-signed
          path: dist

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${{ needs.create_release.outputs.tag }}"
          IPA=$(find dist -name "*.ipa" | head -n 1)

          if [ -z "$IPA" ]; then
            echo "❌ No IPA found to upload"
            exit 1
          fi

          gh release upload "$TAG" "$IPA" --clobber --repo "$GITHUB_REPOSITORY"
